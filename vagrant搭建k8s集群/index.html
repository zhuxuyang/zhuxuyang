<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <title>vagrant搭建k8s集群 | IT工作组</title>
  <meta name="keywords" content=" vagrant , docker , k8s ">
  <meta name="description" content="vagrant搭建k8s集群 | IT工作组">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="阳阳 hexo 个人博客笔记">
<meta name="keywords" content="阳阳 个人笔记 个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="Tags">
<meta property="og:url" content="https://itwork.group/tags/index.html">
<meta property="og:site_name" content="IT工作组">
<meta property="og:description" content="阳阳 hexo 个人博客笔记">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-01-11T02:05:48.631Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tags">
<meta name="twitter:description" content="阳阳 hexo 个人博客笔记">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.0.1" rel="stylesheet">

<link href="/css/hl_theme/atom-light.css?v=1.0.1" rel="stylesheet">

<link href="//cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet">
<link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="/js/jquery.autocomplete.min.js?v=1.0.1"></script>

<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>



<script src="//cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

<script src="/js/iconfont.js?v=1.0.1"></script>

</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="false">
  <input class="theme_blog_path" value="">
</div>

<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar.jpg">
</a>
<div class="author">
    <span>阳阳</span>
</div>

<div class="icon">
    
        
        <a title="github" href="https://github.com/zhuxuyang" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-github"/>
                </svg>
            
        </a>
        
    
        
        <a title="email" href="mailto:imzhuxuyang@gmail.com" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-email"/>
                </svg>
            
        </a>
        
    
</div>




<ul>
    <li><div class="all active">全部文章<small>(24)</small></div></li>
    
        
            
            <li><div data-rel="生活">生活<small>(3)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="工具">工具<small>(4)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="后端服务器">后端服务器<small>(12)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="人工智能">人工智能<small>(1)</small></div>
                
            </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    
    </div>
    <div><a class="about  hasFriend  site_url" href="/about">关于</a><a style="width: 50%" class="friends">友链</a></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="24">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="back-title-list"></i>
    </div>
    <div class="friends-content">
        <ul>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <form onkeydown="if(event.keyCode === 13){return false;}">
        <input id="local-search-input" class="search" type="text" placeholder="Search...">
        <i class="cross"></i>
        <span>
            <label for="tagswitch">Tags:</label>
            <input id="tagswitch" type="checkbox" style="display: none">
            <i id="tagsWitchIcon"></i>
        </span>
    </form>
    <div class="tags-list">
    
    <li class="article-tag-list-item">
        <a class="color3">vagrant</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">windows</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color1">shell</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color2">docker</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color2">golang</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">sips</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">ssh</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color1">nginx</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color1">mysql</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color1">redis</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color2">ubuntu</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color2">nvidia</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">双显卡</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">道理</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">wordpress</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color2">apache</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">vps</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color5">hexo</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color3">博客</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color4">k8s</a>
    </li>
    
    <div class="clearfix"></div>
</div>

    
    <nav id="title-list-nav">
        
        <a class="生活 " href="/ 大多完美者，不过是想象/" data-tag="" data-author="">
            <span class="post-title" title="大多完美者，不过是想象">大多完美者，不过是想象</span>
            <span class="post-date" title="2018-12-26 14:10:42">2018/12/26</span>
        </a>
        
        <a class="工具 " href="/Vagrant初体验/" data-tag="vagrant" data-author="">
            <span class="post-title" title="Vagrant初体验">Vagrant初体验</span>
            <span class="post-date" title="2018-08-01 17:53:44">2018/08/01</span>
        </a>
        
        <a class="工具 " href="/Vagrant集成开发环境的巧妙使用/" data-tag="vagrant,windows,shell" data-author="">
            <span class="post-title" title="Vagrant集成开发环境的巧妙使用">Vagrant集成开发环境的巧妙使用</span>
            <span class="post-date" title="2018-08-10 13:56:19">2018/08/10</span>
        </a>
        
        <a class="" href="/docker自动化部署应用/" data-tag="docker" data-author="">
            <span class="post-title" title="docker自动化部署应用">docker自动化部署应用</span>
            <span class="post-date" title="2018-09-24 17:38:40">2018/09/24</span>
        </a>
        
        <a class="后端服务器 " href="/golang的依赖管理gomod的使用/" data-tag="golang" data-author="">
            <span class="post-title" title="golang的依赖管理gomod的使用">golang的依赖管理gomod的使用</span>
            <span class="post-date" title="2019-01-09 13:20:26">2019/01/09</span>
        </a>
        
        <a class="工具 " href="/mac自带的工具sips处理图片翻转剪切格式转换/" data-tag="sips" data-author="">
            <span class="post-title" title="mac自带的工具sips处理图片翻转剪切格式转换">mac自带的工具sips处理图片翻转剪切格式转换</span>
            <span class="post-date" title="2019-08-15 18:02:33">2019/08/15</span>
        </a>
        
        <a class="" href="/golang重点笔记/" data-tag="golang" data-author="">
            <span class="post-title" title="golang重点笔记">golang重点笔记</span>
            <span class="post-date" title="2019-09-23 14:52:35">2019/09/23</span>
        </a>
        
        <a class="后端服务器 " href="/ssh连接长时间闲置不断线/" data-tag="ssh" data-author="">
            <span class="post-title" title="ssh连接长时间闲置不断线">ssh连接长时间闲置不断线</span>
            <span class="post-date" title="2018-09-03 18:14:49">2018/09/03</span>
        </a>
        
        <a class="后端服务器 " href="/nginx配置文件服务器/" data-tag="nginx" data-author="">
            <span class="post-title" title="nginx配置文件服务器">nginx配置文件服务器</span>
            <span class="post-date" title="2018-09-25 13:24:36">2018/09/25</span>
        </a>
        
        <a class="后端服务器 " href="/mysql开启远程访问/" data-tag="mysql" data-author="">
            <span class="post-title" title="mysql开启远程访问">mysql开启远程访问</span>
            <span class="post-date" title="2017-12-06 15:58:02">2017/12/06</span>
        </a>
        
        <a class="后端服务器 " href="/redis事务的重点/" data-tag="redis" data-author="">
            <span class="post-title" title="redis的事务的重点">redis的事务的重点</span>
            <span class="post-date" title="2018-09-06 20:52:31">2018/09/06</span>
        </a>
        
        <a class="人工智能 " href="/ubuntu双显卡自动安装nvidia显卡驱动/" data-tag="ubuntu,nvidia,双显卡" data-author="">
            <span class="post-title" title="ubuntu双显卡自动安装nvidia显卡驱动">ubuntu双显卡自动安装nvidia显卡驱动</span>
            <span class="post-date" title="2019-01-19 10:20:40">2019/01/19</span>
        </a>
        
        <a class="生活 " href="/人生道理记录/" data-tag="道理" data-author="">
            <span class="post-title" title="人生道理记录">人生道理记录</span>
            <span class="post-date" title="2018-12-15 21:43:07">2018/12/15</span>
        </a>
        
        <a class="后端服务器 " href="/ubuntu安装社区版docker-ce/" data-tag="docker,ubuntu" data-author="">
            <span class="post-title" title="ubuntu安装社区版docker-ce">ubuntu安装社区版docker-ce</span>
            <span class="post-date" title="2018-09-03 18:11:50">2018/09/03</span>
        </a>
        
        <a class="后端服务器 " href="/使用docker部署nginx-并反向代理转发请求/" data-tag="docker,nginx" data-author="">
            <span class="post-title" title="使用docker部署nginx,并反向代理转发请求">使用docker部署nginx,并反向代理转发请求</span>
            <span class="post-date" title="2018-09-03 18:17:23">2018/09/03</span>
        </a>
        
        <a class="后端服务器 " href="/使用docker部署wordpress/" data-tag="docker,wordpress" data-author="">
            <span class="post-title" title="使用docker部署wordpress">使用docker部署wordpress</span>
            <span class="post-date" title="2017-12-06 14:59:33">2017/12/06</span>
        </a>
        
        <a class="后端服务器 " href="/使用wordpress搭建个人博客/" data-tag="wordpress" data-author="">
            <span class="post-title" title="使用wordpress搭建个人博客">使用wordpress搭建个人博客</span>
            <span class="post-date" title="2017-11-06 15:56:20">2017/11/06</span>
        </a>
        
        <a class="" href="/命令/" data-tag="" data-author="">
            <span class="post-title" title=""></span>
            <span class="post-date" title="2020-01-11 10:05:48">2020/01/11</span>
        </a>
        
        <a class="后端服务器 " href="/域名指向的apache默认首页改为wordpress网站首页/" data-tag="wordpress,apache" data-author="">
            <span class="post-title" title="域名指向的apache默认首页改为wordpress网站首页">域名指向的apache默认首页改为wordpress网站首页</span>
            <span class="post-date" title="2017-11-07 15:59:26">2017/11/07</span>
        </a>
        
        <a class="后端服务器 " href="/新入手VPS后一般需要做的事情/" data-tag="vps" data-author="">
            <span class="post-title" title="新入手VPS后一般需要做的事情">新入手VPS后一般需要做的事情</span>
            <span class="post-date" title="2017-12-06 15:57:18">2017/12/06</span>
        </a>
        
        <a class="" href="/失眠有感/" data-tag="" data-author="">
            <span class="post-title" title="失眠有感">失眠有感</span>
            <span class="post-date" title="2020-02-25 23:04:37">2020/02/25</span>
        </a>
        
        <a class="工具 " href="/用hexo写博客的一些坑/" data-tag="hexo,博客" data-author="">
            <span class="post-title" title="用hexo写博客的一些坑">用hexo写博客的一些坑</span>
            <span class="post-date" title="2018-09-03 18:00:18">2018/09/03</span>
        </a>
        
        <a class="生活 " href="/新冠肺炎诗三则/" data-tag="" data-author="">
            <span class="post-title" title="“新冠肺炎诗三则”">“新冠肺炎诗三则”</span>
            <span class="post-date" title="2020-02-25 23:11:34">2020/02/25</span>
        </a>
        
        <a class="后端服务器 " href="/vagrant搭建k8s集群/" data-tag="vagrant,docker,k8s" data-author="">
            <span class="post-title" title="vagrant搭建k8s集群">vagrant搭建k8s集群</span>
            <span class="post-date" title="2019-09-07 21:55:55">2019/09/07</span>
        </a>
        
    </nav>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div class="post">
    <div class="pjax">
        <article id="post-vagrant搭建k8s集群" class="article article-type-post" itemscope="" itemprop="blogPost">
    
        <h1 class="article-title">vagrant搭建k8s集群</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            
                <a data-rel="后端服务器">后端服务器</a>
            
        </span>
        
        
        <span class="tag">
            
            <a class="color3">vagrant</a>
            
            <a class="color2">docker</a>
            
            <a class="color4">k8s</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
        创建时间:<time class="date" title="更新时间: 2020-01-11 10:05:48">2019-09-07 21:55</time>
        
    </div>
    <div class="article-meta">
        
        
        <span id="busuanzi_container_page_pv">
            阅读:<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#宿主机的配置"><span class="toc-text">宿主机的配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#k8s安装基础环境配置"><span class="toc-text">k8s安装基础环境配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#k8s系统网络环境配置"><span class="toc-text">k8s系统网络环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#集群的机器准备"><span class="toc-text">集群的机器准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#集群配置文件"><span class="toc-text">集群配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置集群的内部网络环境flannel"><span class="toc-text">配置集群的内部网络环境flannel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#添加其他机器到集群中"><span class="toc-text">添加其他机器到集群中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#总结几个大步骤"><span class="toc-text">总结几个大步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#最后"><span class="toc-text">最后</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>我使用之前的vagrant工具，启动了ubuntu16.04虚拟机，并且安装了docker,git工具，然后导出了自己的vagrant box文件，命名为docker.box。 然后基于这个box 搭建k8s。</p>
<h3 id="宿主机的配置"><a href="#宿主机的配置" class="headerlink" title="宿主机的配置"></a>宿主机的配置</h3><p>在合适的地方创建cluster文件夹，然后将docker.box移入这个目录，不移入也没关系，我这是便于管理。然后参考之前的教程，步骤都是一样滴，添加box到vagrant，执行vagrant init  docker，在当前目录生成Vagrantfile，然后修改默认的Vagrantfile，启动虚拟机。</p>
<p>Vagrantfile配置文件改为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Vagrant.configure("2") do |config|</span><br><span class="line">  config.vm.box = "docker"</span><br><span class="line">  config.vm.define "master" do |master|  # 第一个虚拟机,名字为master，配置命名为master</span><br><span class="line">        master.vm.network "private_network", ip: "192.168.100.100"</span><br><span class="line">        master.vm.hostname = "master"</span><br><span class="line">        master.vm.provider "virtualbox" do|pmaster|</span><br><span class="line">                pmaster.memory = "1024"</span><br><span class="line">                pmaster.cpus = 1</span><br><span class="line">        end</span><br><span class="line">  end</span><br></pre></td></tr></table></figure>
<h3 id="k8s安装基础环境配置"><a href="#k8s安装基础环境配置" class="headerlink" title="k8s安装基础环境配置"></a>k8s安装基础环境配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 创建安装源配置文件</span><br><span class="line">sudo touch /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line"><span class="meta">#</span> 设置文件可写</span><br><span class="line">sudo chmod 666 /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line"><span class="meta">#</span> 添加下载源到文件末尾</span><br><span class="line">sudo cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 更新源</span><br><span class="line">sudo apt update</span><br><span class="line"><span class="meta">#</span> 然而报错了，说 the public key is not available: NO_PUBKEY 6A030B21BA07F4FB</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 添加key的后八位 BA07F4FB 到系统中，这个步骤其实是k8s的安全下载措施</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 在机器上生成证书</span><br><span class="line">sudo gpg --keyserver keyserver.ubuntu.com --recv-keys BA07F4FB</span><br><span class="line"><span class="meta">#</span> 添加证书到k8s的环境中</span><br><span class="line">sudo gpg --export --armor BA07F4FB | sudo apt-key add -</span><br><span class="line"><span class="meta">#</span> 更新下载源</span><br><span class="line">sudo apt update</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 一般涉及到网络的服务，都会禁止系统自带的安全模块，防止出错</span><br><span class="line"><span class="meta">#</span> 禁止系统自带的防火墙unix firewall </span><br><span class="line">sudo ufw disable</span><br><span class="line"><span class="meta">#</span> 关闭系统swap,一般是永久关闭，然而vagrant的ubuntu16.04虚拟机默认就是关闭的</span><br><span class="line"><span class="meta">#</span> 在系统文件 /etc/fstab 里没有swap.img的配置，如果有，注释掉就是永久关闭swap了</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 禁止selinux,这是ubuntu自带的类似360的软件,这个我猜不做也可以，</span><br><span class="line"><span class="meta">#</span> 不过这个软件影响机器性能，还没什么用，禁了。要禁止它需要下载他的工具selinux-utils</span><br><span class="line">sudo apt install -y selinux-utils</span><br><span class="line"><span class="meta">#</span> 关闭它</span><br><span class="line">setenforce 0</span><br><span class="line"><span class="meta">#</span> 查看是否已经关闭 selinux</span><br><span class="line">sudo getenforce </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 重启机器</span><br><span class="line">sudo shutdown  -r now</span><br></pre></td></tr></table></figure>
<h3 id="k8s系统网络环境配置"><a href="#k8s系统网络环境配置" class="headerlink" title="k8s系统网络环境配置"></a>k8s系统网络环境配置</h3><p>创建 /etc/sysctl.d/k8s.conf 文件，写入内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 修改文件可读可写</span><br><span class="line">sudo chmod 666 /etc/sysctl.d/k8s.conf</span><br><span class="line"><span class="meta">#</span> 添加内容</span><br><span class="line">sudo cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>与视频不一致，我这个是官网复制的，视频里多了一行    vm.swappiness=0</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 使用modproble加载网桥透明防火墙</span><br><span class="line">sudo modprobe br_netfilter</span><br><span class="line"><span class="meta">#</span> 使配置文件生效</span><br><span class="line">sudo sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line"><span class="meta">#</span> 安装k8s</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt-get install kubelet kubernetes-cni kubectl kubeadm</span><br></pre></td></tr></table></figure>
<p>vagrant 里如果需要root权限，可能无法授权。可以先sudo passwd root 先给root设定一个密码就可以了。</p>
<p>重启机器，到这个时候，如果执行kubectl get nodes,显示</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The connection to the server localhost:8080 was refused - did you specify the right host or port?</span><br></pre></td></tr></table></figure>
<p>这是网络环境还不对，但是命令已经有了。</p>
<p>使用vagrant给机器做个镜像，导出镜像为 k8s.box ，添加k8s.box到 vagrant  box list 里，之后需要根据这个box 部署集群。</p>
<h4 id="集群的机器准备"><a href="#集群的机器准备" class="headerlink" title="集群的机器准备"></a>集群的机器准备</h4><p>准备三台虚拟机，分别为master,slave01,slave02</p>
<p>在cluster目录下，创建两个文件夹 master和slave，分别在这两个文件夹下创建Vagrantfile</p>
<p>第一个：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Vagrant.configure("2") do |config|</span><br><span class="line">  config.vm.box = "k8s"</span><br><span class="line">  config.vm.define "master" do |master|  # 第一个虚拟机，打算作为k8s的master,配置命名为master</span><br><span class="line">        master.vm.network "private_network", ip: "192.168.100.100"</span><br><span class="line">        master.vm.hostname = "master"</span><br><span class="line">        master.vm.provider "virtualbox" do|pmaster|</span><br><span class="line">                pmaster.memory = "1024"</span><br><span class="line">                pmaster.cpus = 1</span><br><span class="line">        end</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>第二个</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Vagrant.configure("2") do |config| # 表示使用版本2的配置文件格式启动，配置命名为config，下面可以引用</span><br><span class="line">  config.vm.box = "k8s"  # 指定box list 里的 box </span><br><span class="line"></span><br><span class="line">  config.vm.define "slave01" do |slave01|  # 虚拟机名字为slave01，配置命名为slave01</span><br><span class="line">        master.vm.network "private_network", ip: "192.168.100.101"</span><br><span class="line">        master.vm.hostname = "slave01"</span><br><span class="line">        master.vm.provider "virtualbox" do|pslave01|</span><br><span class="line">                pmaster.memory = "1024"</span><br><span class="line">                pmaster.cpus = 1</span><br><span class="line">        end</span><br><span class="line">   end</span><br><span class="line">   config.vm.define "slave02" do|slave02|</span><br><span class="line">        slave01.vm.hostname = "slave02"</span><br><span class="line">        slave01.vm.network "private_network", ip: "192.168.100.102"</span><br><span class="line">        slave01.vm.provider "virtualbox" do|pslave02|</span><br><span class="line">                pslave01.memory = "1024"</span><br><span class="line">                pslave01.cpus = 1</span><br><span class="line">        end</span><br><span class="line">   end   </span><br><span class="line">   </span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>启动三个虚拟机，根据各自的ip修改他们的 /etc/hosts,在文件中添加</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.100.100 master</span><br><span class="line">192.168.100.101 slave01</span><br><span class="line">192.168.100.102 slave02</span><br></pre></td></tr></table></figure>
<p>使它们可以根据机器名字互相ping通</p>
<h4 id="集群配置文件"><a href="#集群配置文件" class="headerlink" title="集群配置文件"></a>集群配置文件</h4><p>登陆master,在～目录下创建working文件夹，然后生成配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir working</span><br><span class="line">cd working</span><br><span class="line">kubeadm config print init-defaults ClusterConfiguration &gt; kubeadm.conf</span><br></pre></td></tr></table></figure>
<p>配置文件稍作修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 镜像源修改</span><br><span class="line">imageRepository: registry.aliyuncs.com/google_containers  </span><br><span class="line"><span class="meta">#</span> 本机ip</span><br><span class="line">advertiseAddress: 192.168.100.100</span><br><span class="line"><span class="meta">#</span> 最后的网络</span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  podSubnet: 10.244.0.0/16  # pod之间的通信网络</span><br><span class="line">  serviceSubnet: 10.96.0.0/12 # pod之间的通信网络</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 查看需要下载的模块</span><br><span class="line">kubeadm config images list --config kubeadm.conf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 下载模块</span><br><span class="line">kubeadm config images pull --config kubeadm.conf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 初始化生成master</span><br><span class="line">sudo kubeadm init --config ./kubeadm.conf</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ol>
<li>registry.aliyuncs.com/google_containers/kube-apiserver:v1.16.0  apiserver提供对外接口，外部通过访问apiserver进入到集群中，所以每个kubelet都有这个</li>
<li>registry.aliyuncs.com/google_containers/kube-controller-manager:v1.16.0 Controller Manager作为集群内部的管理控制中心，负责集群内的Node、Pod副本、服务端点（Endpoint）、命名空间（Namespace）、服务账号（ServiceAccount）、资源定额（ResourceQuota）的管理，当某个Node意外宕机时，Controller Manager会及时发现并执行自动化修复流程，确保集群始终处于预期的工作状态。</li>
<li>registry.aliyuncs.com/google_containers/kube-scheduler:v1.16.0。调度器是一个策略丰富、拓扑感知、工作负载特定的功能，显著影响可用性、性能和容量。调度器需要考虑个人和集体 的资源要求、服务质量要求、硬件/软件/政策约束、亲和力和反亲和力规范、数据局部性、负载间干扰、完成期限等。 工作负载特定的要求必要时将通过 API 暴露。</li>
<li>registry.aliyuncs.com/google_containers/kube-proxy:v1.16.0.  主要做内部的负载均衡</li>
<li>registry.aliyuncs.com/google_containers/pause:3.1。Kubernetes创建Pod时，首先会创建一个pause容器，为Pod指派一个唯一的IP地址。然后，以pause的网络命名空间为基础，创建同一个Pod内的其它容器（–net=container:xxx）。因此，同一个Pod内的所有容器就会共享同一个网络命名空间，在同一个Pod之间的容器可以直接使用localhost进行通信。</li>
<li>registry.aliyuncs.com/google_containers/etcd:3.3.15-0    各个容器数据的内部一致性</li>
<li>registry.aliyuncs.com/google_containers/coredns:1.6.2 </li>
</ol>
<p>上面的模块安装后，会提示执行如下指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span># 本地环境配置</span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 其他机器加入集群，这个提示的token要备份，以后其他机器加入集群都要用</span><br><span class="line"><span class="meta">#</span> kubeadm join 192.168.100.100:6443 --token  巴啦啦啦一大堆</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 开机启动</span><br><span class="line">sudo systemctl enable kubelet</span><br><span class="line">sudo systemctl start kubelet</span><br><span class="line"><span class="meta">#</span> 查看命令,这个时候终于有了,但是status还是NotReady，是因为还没有配置内部网络环境</span><br><span class="line">kubectl get node</span><br></pre></td></tr></table></figure>
<h4 id="配置集群的内部网络环境flannel"><a href="#配置集群的内部网络环境flannel" class="headerlink" title="配置集群的内部网络环境flannel"></a>配置集群的内部网络环境flannel</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 下载一个配置文件</span><br><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"><span class="meta">#</span> 修改里面的 net-conf.json选项，网络为 kubeadm.conf配置文件里面的网络</span><br><span class="line"><span class="meta">#</span>     &#123;</span><br><span class="line"><span class="meta">#</span>       "Network": "10.244.0.0/16",</span><br><span class="line"><span class="meta">#</span>       "Backend": &#123;</span><br><span class="line"><span class="meta">#</span>        "Type": "vxlan"</span><br><span class="line"><span class="meta">#</span>       &#125;</span><br><span class="line"><span class="meta">#</span>     &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 执行命令生效flannel配置</span><br><span class="line">kubeadm apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure>
<p>过一会儿，等配置生效。然后执行  kubectl get nodes 命令，status就是ready了。到此，master终于弄好了。</p>
<h4 id="添加其他机器到集群中"><a href="#添加其他机器到集群中" class="headerlink" title="添加其他机器到集群中"></a>添加其他机器到集群中</h4><p>将master机器里的两个文件分别复制到slave01和slave02机器里。</p>
<p> /etc/kubernetes/admin.conf   </p>
<p>~/working/kube-flannel.yml</p>
<p>登陆进入slave01机器，执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 开机启动</span><br><span class="line">sudo systemctl enable kubelet</span><br><span class="line">sudo systemctl start kubelet</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 用admin.conf文件生成k8s配置文件</span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i admin.conf .kube/config </span><br><span class="line">sudo chown $(id -u):$(id -g) .kube/config </span><br><span class="line"><span class="meta">#</span> 用mster初始化的时候生成的信息加入到集群中</span><br><span class="line">sudo kubeadm join 192.168.100.100:6443 --token abcde巴拉巴拉一大堆</span><br></pre></td></tr></table></figure>
<p>到此为止，slave01已经加入到集群里，过一会儿等它生效，执行  kubectl get nodes 命令，会看到有两台机器，且status是ready了。slave02也是一样的操作。</p>
<p>最后，如果slave机器一直都是notready，还需要配置slave01和slave02可以互相通信，就需要用到master里复制过来的kube-flannel.yml文件了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure>
<h4 id="总结几个大步骤"><a href="#总结几个大步骤" class="headerlink" title="总结几个大步骤"></a>总结几个大步骤</h4><ol>
<li>master机器上kubeadm init –config 创建master，生成配置文件</li>
<li>配置集群的内部通信网络，flannel网络</li>
<li>配置node节点，分配网络</li>
<li>让node加入集群</li>
</ol>
<h4 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h4><p>到此为止，终于部署好三台机器的k8s集群，可以分别给master和node做镜像，防止以后还要重新这样部署一遍，啦啦啦   ：）</p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 jaytp@qq.com </span>
    </div>
</article>



<div class="article_copyright">
    <p><span class="copy-title">文章标题:</span>vagrant搭建k8s集群</p>
    
    <p><span class="copy-title">本文作者:</span><a title="阳阳">阳阳</a></p>
    <p><span class="copy-title">发布时间:</span>2019-09-07, 21:55:55</p>
    <p><span class="copy-title">最后更新:</span>2020-01-11, 10:05:48</p>
    <span class="copy-title">原始链接:</span><a class="post-url" href="/vagrant搭建k8s集群/" title="vagrant搭建k8s集群">https://itwork.group/vagrant搭建k8s集群/</a>
    <p>
        <span class="copy-title">版权声明:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target="_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
    </p>
</div>





    




    </div>
    <div class="copyright">
        <p class="footer-entry">©2016-2020 阳阳</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full"><span class="min "></span></button>
<button class="post-toc-menu"><span class="post-toc-menu-icons"></span></button>
<div class="post-toc"><span class="post-toc-title">目录</span>
    <div class="post-toc-content">

    </div>
</div>
<a class="" id="rocket"></a>

    </div>
</div>
<div class="acParent"></div>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
<script src="/js/jquery.pjax.js?v=1.0.1"></script>

<script src="/js/script.js?v=1.0.1"></script>
<script>
    var img_resize = 'default';
    /*作者、标签的自动补全*/
    $(function () {
        $('.search').AutoComplete({
            'data': ['#vagrant','#windows','#shell','#docker','#golang','#sips','#ssh','#nginx','#mysql','#redis','#ubuntu','#nvidia','#双显卡','#道理','#wordpress','#apache','#vps','#hexo','#博客','#k8s',],
            'itemHeight': 20,
            'width': 418
        }).AutoComplete('show');
    })
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $(".post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        
        $('pre code').each(function(){
            var lines = $(this).text().split('\n').length - 1, widther='';
            if (lines>99) {
                widther = 'widther'
            }
            var $numbering = $('<ul/>').addClass('pre-numbering ' + widther).attr("unselectable","on");
            $(this).addClass('has-numbering ' + widther)
                    .parent()
                    .append($numbering);
            for(var i=1;i<=lines;i++){
                $numbering.append($('<li/>').text(i));
            }
        });
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<style>
    pre{
        position: relative;
        margin-bottom: 24px;
        border-radius: 10px;
        border: 1px solid #e2dede;
        background: #FFF;
        overflow: hidden;
    }
    code.has-numbering{
        margin-left: 30px;
    }
    code.has-numbering.widther{
        margin-left: 35px;
    }
    .pre-numbering{
        margin: 0px;
        position: absolute;
        top: 0;
        left: 0;
        width: 20px;
        padding: 0.5em 3px 0.7em 5px;
        border-right: 1px solid #C3CCD0;
        text-align: right;
        color: #AAA;
        background-color: #fafafa;
    }
    .pre-numbering.widther {
        width: 35px;
    }
</style>

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
        .nav .hide-list.fullscreen {
            left: 492px
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    
    .post .pjax article .article-entry>ol, .post .pjax article .article-entry>ul, .post .pjax article>ol, .post .pjax article>ul{
        border: #e2dede solid 1px;
        border-radius: 10px;
        padding: 10px 32px 10px 56px;
    }
    .post .pjax article .article-entry li>ol, .post .pjax article .article-entry li>ul,.post .pjax article li>ol, .post .pjax article li>ul{
        padding-top: 5px;
        padding-bottom: 5px;
    }
    .post .pjax article .article-entry>ol>li, .post .pjax article .article-entry>ul>li,.post .pjax article>ol>li, .post .pjax article>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    .post .pjax article .article-entry li>ol>li, .post .pjax article .article-entry li>ul>li,.post .pjax article li>ol>li, .post .pjax article li>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.3;
        background: url("https://i.loli.net/2019/07/22/5d3521411f3f169375.png");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    

    
</style>







</html>
